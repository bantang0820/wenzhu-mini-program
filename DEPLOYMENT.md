# 部署指南 📦

详细的部署步骤，帮助你快速将正念家长 SOS 小程序部署到生产环境。

## 第一步：配置小程序基本信息

### 1.1 修改 project.config.json

```json
{
  "appid": "你的小程序AppID",
  "projectname": "mindful-parenting"
}
```

获取 AppID:
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 "开发" → "开发设置"
3. 复制 AppID

### 1.2 配置云开发环境

在 `app.js` 中修改环境ID:

```javascript
wx.cloud.init({
  env: 'your-env-id', // 替换为你的云开发环境ID
  traceUser: true,
});
```

获取环境ID:
1. 打开微信开发者工具
2. 点击 "云开发" 按钮
3. 在 "设置" → "环境设置" 中复制环境ID

## 第二步：创建数据库

### 2.1 创建数据库集合

在云开发控制台 → 数据库，创建以下集合：

| 集合名 | 用途 | 权限设置 |
|--------|------|----------|
| scenarios | 场景库 | 所有用户可读，仅管理员可写 |
| users | 用户表 | 仅创建者可读写 |
| emotion_logs | 情绪日志 | 仅创建者可读写 |

### 2.2 导入初始数据

1. 在云开发控制台选择 `scenarios` 集合
2. 点击 "导入"
3. 选择 `database/scenarios.json` 文件
4. 导入格式选择 "JSON"
5. 点击 "确定导入"

### 2.3 设置数据库权限

在云开发控制台 → 数据库 → 权限设置:

**scenarios 集合**:
```json
{
  "read": true,
  "write": false
}
```

**emotion_logs 集合**:
```json
{
  "read": "doc.user_id == auth.openid",
  "write": "doc.user_id == auth.openid"
}
```

**users 集合**:
```json
{
  "read": "doc._openid == auth.openid",
  "write": "doc._openid == auth.openid"
}
```

## 第三步：部署云函数

### 3.1 上传云函数

1. 在微信开发者工具中，右键 `cloudfunctions/logEmotion` 目录
2. 选择 "上传并部署：云端安装依赖"
3. 等待上传和部署完成
4. 成功后，目录图标会变成云朵形状 ☁️

### 3.2 测试云函数

在云开发控制台 → 云函数 → logEmotion:

点击 "测试"，输入测试数据:
```json
{
  "scenario_id": "001",
  "scenario_title": "孩子磨蹭",
  "duration": 15000,
  "timestamp": "2025-01-15T10:30:00.000Z"
}
```

点击 "开始测试"，应该返回:
```json
{
  "success": true,
  "log_id": "xxx",
  "message": "情绪记录成功"
}
```

## 第四步：配置小程序信息

### 4.1 设置小程序基本信息

在微信公众平台 → 设置 → 基本信息:

- **小程序名称**: 正念家长
- **简介**: 帮助家长在情绪崩溃时进行自我急救
- **头像**: 上传小程序 Logo（建议使用极简风格）

### 4.2 配置用户隐私

在微信公众平台 → 设置 → 基本服务设置:

- **用户隐私保护指引**: 勾选 "不收集用户信息"
- **隐私设置**: 配置隐私政策页面

### 4.3 设置服务器域名

如果需要调用外部 API，在开发 → 开发设置 → 服务器域名中添加。

本项目使用云开发，无需配置。

## 第五步：测试

### 5.1 真机调试

1. 点击工具栏的 "预览" 按钮
2. 使用微信扫描二维码
3. 在手机上测试所有功能

### 5.2 功能测试清单

- [ ] 首页场景正常显示
- [ ] 免费场景可以点击
- [ ] 付费场景点击后提示解锁
- [ ] 详情页正常显示内容
- [ ] 点击"完成"按钮有动画效果
- [ ] 情绪日志正常记录到数据库
- [ ] 觉察日记页面正常显示
- [ ] Tab 切换正常

### 5.3 性能测试

- 首屏加载时间 < 2秒
- 页面切换流畅无卡顿
- 动画效果自然

## 第六步：提交审核

### 6.1 上传代码

1. 在微信开发者工具中，点击 "上传" 按钮
2. 填写版本号: 1.0.0
3. 填写项目备注: 正念家长 SOS MVP 版本
4. 点击 "上传"

### 6.2 提交审核

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 "版本管理"
3. 在 "开发版本" 中点击 "提交审核"
4. 填写审核信息:

   - **小程序页面路径**: pages/index/index
   - **测试号**: 不需要（如果没有测试功能）
   - **功能页面**: 选择对应的类目（教育 → 育儿）

5. 等待审核（通常 1-7 个工作日）

### 6.3 审核注意事项

确保符合以下要求:

- ✅ 无违规内容
- ✅ 无诱导分享
- ✅ 无强制关注
- ✅ 隐私政策完整
- ✅ 无明显 Bug

## 第七步：发布

审核通过后，在微信公众平台 → 版本管理 → 审核版本，点击 "发布"。

**🎉 恭喜！小程序已成功发布！**

## 常见问题

### Q1: 云函数调用失败

**A**: 检查以下几点:
1. 云函数是否成功部署
2. 环境ID是否正确配置
3. 数据库权限是否正确设置

### Q2: 数据库读取失败

**A**: 检查以下几点:
1. 数据库集合是否创建
2. 是否导入了初始数据
3. 权限设置是否正确

### Q3: 页面样式不对

**A**: 确保以下几点:
1. app.wxss 是否正确引入
2. 是否清除了缓存
3. 基础库版本 >= 2.2.3

### Q4: 如何添加更多场景

**A**:
1. 在云开发控制台的 `scenarios` 集合中添加新记录
2. 或修改 `database/scenarios.json` 重新导入

### Q5: 如何开通会员系统

**A**:
需要对接微信支付:
1. 申请微信支付商户号
2. 配置支付目录
3. 开发支付接口
4. 实现 `isPro` 状态管理

## 更新日志

### v1.0.0 (2025-01-15)

- ✨ 初始版本发布
- 📱 实现场景网格首页
- 🎯 实现急救卡片详情页
- 💾 实现情绪记录功能
- 🔒 实现会员权限控制
- 📊 实现觉察日记占位页

## 支持

如有问题，请提交 Issue 或联系开发者。

---

**祝部署顺利！** 🚀
